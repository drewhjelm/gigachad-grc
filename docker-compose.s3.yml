# ============================================================================
# Docker Compose Override for S3/LocalStack Mode
# ============================================================================
# 
# Use this override file when running with LocalStack S3 instead of RustFS:
#   docker compose -f docker-compose.yml -f docker-compose.s3.yml up -d
#
# Required environment variables (set in .env file):
#   STORAGE_TYPE   - Set to "s3"
#   S3_ENDPOINT    - S3/LocalStack endpoint (e.g., "host.docker.internal")
#   S3_PORT        - S3/LocalStack port (e.g., "4566")
#   S3_ACCESS_KEY  - S3 access key
#   S3_SECRET_KEY  - S3 secret key
#   S3_BUCKET      - S3 bucket name (e.g., "grc-storage")
#
# This overrides the S3 configuration to point to LocalStack running on host.
# ============================================================================

services:
  # Override rustfs with a minimal stub that satisfies dependencies
  # No ports exposed - using LocalStack S3 instead
  rustfs:
    image: busybox:latest
    container_name: grc-rustfs-stub
    command: ["sh", "-c", "echo 'RustFS disabled - using LocalStack S3' && sleep infinity"]
    ports: !reset []  # Clear all port mappings from base config
    volumes: !reset []  # Clear all volume mappings from base config
    environment: {}  # Clear environment
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 1s
    networks:
      - grc-network

  # Override controls service to use S3/LocalStack
  controls:
    environment:
      STORAGE_TYPE: ${STORAGE_TYPE:-s3}
      S3_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      S3_PORT: ${S3_PORT:-4566}
      S3_USE_SSL: ${S3_USE_SSL:-false}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-grc-storage}
      MINIO_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      MINIO_PORT: ${S3_PORT:-4566}
      MINIO_USE_SSL: ${S3_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${S3_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_SECRET_KEY}
      MINIO_BUCKET: ${S3_BUCKET:-grc-storage}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_started

  # Override frameworks service
  frameworks:
    environment:
      STORAGE_TYPE: ${STORAGE_TYPE:-s3}
      S3_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      S3_PORT: ${S3_PORT:-4566}
      S3_USE_SSL: ${S3_USE_SSL:-false}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-grc-storage}
      MINIO_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      MINIO_PORT: ${S3_PORT:-4566}
      MINIO_USE_SSL: ${S3_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${S3_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_SECRET_KEY}
      MINIO_BUCKET: ${S3_BUCKET:-grc-storage}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Override policies service
  policies:
    environment:
      STORAGE_TYPE: ${STORAGE_TYPE:-s3}
      S3_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      S3_PORT: ${S3_PORT:-4566}
      S3_USE_SSL: ${S3_USE_SSL:-false}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-grc-storage}
      MINIO_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      MINIO_PORT: ${S3_PORT:-4566}
      MINIO_USE_SSL: ${S3_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${S3_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_SECRET_KEY}
      MINIO_BUCKET: ${S3_BUCKET:-grc-storage}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Override tprm service
  tprm:
    environment:
      STORAGE_TYPE: ${STORAGE_TYPE:-s3}
      S3_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      S3_PORT: ${S3_PORT:-4566}
      S3_USE_SSL: ${S3_USE_SSL:-false}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-grc-storage}
      MINIO_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      MINIO_PORT: ${S3_PORT:-4566}
      MINIO_USE_SSL: ${S3_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${S3_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_SECRET_KEY}
      MINIO_BUCKET: ${S3_BUCKET:-grc-storage}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Override trust service
  trust:
    environment:
      STORAGE_TYPE: ${STORAGE_TYPE:-s3}
      S3_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      S3_PORT: ${S3_PORT:-4566}
      S3_USE_SSL: ${S3_USE_SSL:-false}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-grc-storage}
      MINIO_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      MINIO_PORT: ${S3_PORT:-4566}
      MINIO_USE_SSL: ${S3_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${S3_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_SECRET_KEY}
      MINIO_BUCKET: ${S3_BUCKET:-grc-storage}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Override audit service
  audit:
    environment:
      STORAGE_TYPE: ${STORAGE_TYPE:-s3}
      S3_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      S3_PORT: ${S3_PORT:-4566}
      S3_USE_SSL: ${S3_USE_SSL:-false}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-grc-storage}
      MINIO_ENDPOINT: ${S3_ENDPOINT:-host.docker.internal}
      MINIO_PORT: ${S3_PORT:-4566}
      MINIO_USE_SSL: ${S3_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${S3_ACCESS_KEY}
      MINIO_SECRET_KEY: ${S3_SECRET_KEY}
      MINIO_BUCKET: ${S3_BUCKET:-grc-storage}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
